// Generated by LiveScript 1.2.0
(function(){
  var prelude, templating, flat, config, utils, Resource, Collection, Document, toString$ = {}.toString;
  prelude = require('prelude-ls');
  templating = require('url-template');
  flat = require('flat');
  config = require('../config');
  utils = require('../util/utils');
  Resource = require('./Resource');
  Collection = require('./Collection');
  Document = (function(){
    Document.displayName = 'Document';
    var prototype = Document.prototype, constructor = Document;
    function Document(primaryResources, extraResources, meta, urlTemplates){
      var res$, k, ref$, template, type, resources;
      this.primaryResources = primaryResources;
      this.meta = meta;
      this.urlTemplates = urlTemplates;
      this.links = {};
      res$ = {};
      for (k in ref$ = this.urlTemplates) {
        template = ref$[k];
        res$[k] = templating.parse(template);
      }
      this._urlTemplatesParsed = res$;
      this.included = [];
      for (type in extraResources) {
        resources = extraResources[type];
        this.included.concat(resources.map(bind$(this, 'renderResource')));
      }
    }
    prototype.renderResource = function(resource){
      var res, urlTempParams, path, ref$, referenced, isCollection, idKey, x$, referencedArr, this$ = this;
      res = resource.attrs;
      if (resource.id) {
        res.id = resource.id;
      }
      res.type = resource.type;
      if (toString$.call(resource.meta).slice(8, -1) === "Object") {
        res.meta = resource.meta;
      }
      urlTempParams = function(){
        return import$({}, res);
      }();
      res.links = {};
      res.links[config.resourceUrlKey] = this.urlFor(res.type, config.resourceUrlKey, res.id, urlTempParams);
      for (path in ref$ = resource.links) {
        referenced = ref$[path];
        isCollection = referenced instanceof Collection;
        idKey = isCollection
          ? config.homogeneousToManyIdsKey
          : config.toOneIdKey;
        x$ = res.links[path] = {};
        x$['type'] = referenced.type;
        x$[idKey] = referenced[isCollection ? 'ids' : 'id'];
        referencedArr = isCollection
          ? referenced.resources
          : [referenced];
        referencedArr.forEach(fn$);
      }
      return res;
      function fn$(it){
        if (it.attrs != null) {
          return this$.included.push(it);
        }
      }
    };
    prototype.urlFor = function(type, path, referencedIdOrIds, extraParams){
      var params, k, v;
      if (!this._urlTemplatesParsed[type + '.' + path]) {
        throw new Error("Missing url template for " + type + '.' + path);
      }
      params = flat.flatten((function(){
        var ref$, results$ = {};
        for (k in ref$ = extraParams) {
          v = ref$[k];
          results$[type + '.' + k] = v;
        }
        return results$;
      }()), {
        safe: true
      });
      params[type + '.' + path] = referencedIdOrIds;
      return this._urlTemplatesParsed[type + '.' + path].expand(params);
    };
    prototype.get = function(){
      var mainKey, x$, doc, this$ = this;
      mainKey = this.primaryResources.type === 'errors'
        ? 'errors'
        : config.primaryResourcesKey;
      x$ = doc = {};
      if (this.meta) {
        x$['meta'] = this.meta;
      }
      x$[mainKey] = function(){
        var renderedResources;
        if (this$.primaryResources.type === 'errors') {
          renderedResources = utils.mapResources(this$.primaryResources, function(it){
            return it.attrs;
          });
        } else {
          renderedResources = utils.mapResources(this$.primaryResources, bind$(this$, 'renderResource'));
        }
        return renderedResources;
      }();
      if (!prelude.Obj.empty(this.included)) {
        x$['included'] = utils.arrayUnique(this.included);
      }
      if (!prelude.Obj.empty(this.links)) {
        x$['links'] = this.links;
      }
      return doc;
    };
    Document.primaryResourcesfromJSON = function(doc){
      var links, meta, linked, buildResource, key, primaryResources, makeCollection, type;
      links = doc.links, meta = doc.meta, linked = doc.linked;
      buildResource = function(json, type, linked, topLinks){
        var id, href, links, attrs, key, val, linkedType, ref$, linkedIdOrIds, linkedResourceOrResources;
        id = json.id;
        delete json.id;
        href = json.href;
        delete json.href;
        links = json.links;
        delete json.links;
        type = json.type || type;
        delete json.type;
        attrs = json;
        for (key in links) {
          val = links[key];
          linkedType = val.type || ((ref$ = val[0]) != null ? ref$.type : void 8) || (topLinks != null ? (ref$ = topLinks[type + '.' + key]) != null ? ref$.type : void 8 : void 8);
          linkedIdOrIds = typeof val === "string"
            ? val
            : val.id
              ? val.id
              : val instanceof Array
                ? val.map(fn$)
                : val.ids;
          linkedResourceOrResources = utils.mapArrayOrVal(linkedIdOrIds, fn1$);
          links[key] = linkedResourceOrResources instanceof Array ? new Collection(linkedResourceOrResources) : linkedResourceOrResources;
        }
        return new Resource(type, id, attrs, links, href);
        function fn$(it){
          return it.id || it;
        }
        function fn1$(id){
          return new Resource(linkedType, id);
        }
      };
      for (key in doc) {
        if (key !== 'links' && key !== 'meta' && key !== 'linked') {
          primaryResources = doc[key];
          makeCollection = primaryResources instanceof Array;
          type = fn$();
          break;
        }
      }
      if (!makeCollection) {
        primaryResources = [primaryResources];
      }
      primaryResources = primaryResources.map(function(it){
        return buildResource(it, type, linked, links);
      });
      if (makeCollection) {
        return new Collection(primaryResources, null, type);
      } else {
        return primaryResources[0];
      }
      function fn$(){
        if (key !== 'data') {
          return key;
        }
        if (makeCollection) {
          return primaryResources[0].type;
        } else {
          return primaryResources.type;
        }
      }
    };
    return Document;
  }());
  module.exports = Document;
  function bind$(obj, key, target){
    return function(){ return (target || obj)[key].apply(obj, arguments) };
  }
  function import$(obj, src){
    var own = {}.hasOwnProperty;
    for (var key in src) if (own.call(src, key)) obj[key] = src[key];
    return obj;
  }
}).call(this);
